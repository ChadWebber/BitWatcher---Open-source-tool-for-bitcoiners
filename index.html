<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BitWatcher</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--line:#1f2a38;--muted:#9fb0c3;--text:#e7eef6;--accent:#f7931a}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    .pill{background:var(--card);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    main{max-width:1280px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:1000px){main{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar{justify-content:space-between;margin-bottom:10px}
    .btn{background:#0e141c;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .select,.input{background:#0e141c;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    #chart{height:560px}
    label{color:var(--muted);font-size:13px}
    small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    hr{border:0;border-top:1px solid var(--line);margin:16px 0}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <h1>BitWatcher</h1>
    <span class="pill">Open‚Äësource ‚Ä¢ No tracking ‚Ä¢ Live chart</span>
  </header>

  <main>
    <!-- LEFT: Chart -->
    <section class="card">
      <div class="row toolbar">
        <div class="row">
          <label>Range</label>
          <button class="btn" data-range="1D">1D</button>
          <button class="btn" data-range="1Y">1Y</button>
          <button class="btn" data-range="5Y">5Y</button>
        </div>
        <div class="row">
          <label><input type="checkbox" id="ma200d" checked> 200‚Äëday MA</label>
          <label><input type="checkbox" id="ma200w" checked> ~200‚Äëweek MA</label>
          <button class="btn" id="markATHBtn" title="Toggle ATH line">ATH</button>
        </div>
      </div>
      <div id="chart"></div>
      <small>
        Sources: TradingView (candles), CoinGecko (spot/ATH for alerts), mempool.space (on‚Äëchain).
        200‚Äëweek MA approximated as 1400‚Äëday MA on daily candles.
      </small>
    </section>

    <!-- RIGHT: Sidebar -->
    <aside class="card">
      <h3 style="margin:4px 0 8px">Wallet Lookup</h3>
      <input id="addrInput" class="input mono" placeholder="Paste BTC address (mainnet)">
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addrBtn">Lookup</button>
        <button class="btn" id="clearAddrBtn">Clear</button>
      </div>
      <div id="addrResult" style="margin-top:10px">
        <small>Enter a Bitcoin address to view balance, UTXOs and recent TXs.</small>
      </div>

      <hr />

      <h3>Alerts</h3>
      <small id="notifState">Notifications: requesting permission‚Ä¶</small>

      <hr />

      <h3>Donate BTC</h3>
      <p class="mono" id="donationAddr">3Q8gDB9QEgLP71ts3XDK7Ss45wMGjL6BHu</p>
      <small>Thank you for supporting development üôè</small>
    </aside>
  </main>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    /***************
     * TradingView *
     ***************/
    const tvWidget = new TradingView.widget({
      container_id: "chart",
      symbol: "BITSTAMP:BTCUSD",
      interval: "D",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      allow_symbol_change: false,
      hide_top_toolbar: false,
      autosize: true,
      disabled_features: ["header_widget"],
      enabled_features: ["study_templates"],
      overrides: {
        "paneProperties.background": "#121821",
        "paneProperties.vertGridProperties.color": "#1f2a38",
        "paneProperties.horzGridProperties.color": "#1f2a38"
      }
    });

    let chart, sma200dId=null, sma200wId=null, athLineId=null;

    tvWidget.onChartReady(() => {
      chart = tvWidget.activeChart();
      toggleMA('200d', true);
      toggleMA('200w', true);

      // Range buttons (visible window)
      document.querySelectorAll('button[data-range]').forEach(btn => {
        btn.addEventListener('click', () => {
          const k = btn.getAttribute('data-range');
          const now = Math.floor(Date.now()/1000);
          let from = now - 365*24*60*60;  // 1Y default
          if (k==='1D') from = now - 24*60*60;
          if (k==='5Y') from = now - 5*365*24*60*60;
          chart.setVisibleRange({ from, to: now });
          fetchAndCompute(); // refresh alert context
        });
      });

      document.getElementById('ma200d').addEventListener('change', e => toggleMA('200d', e.target.checked));
      document.getElementById('ma200w').addEventListener('change', e => toggleMA('200w', e.target.checked));

      document.getElementById('markATHBtn').addEventListener('click', () => {
        if (!coingecko.ath) return alert('ATH not loaded yet.');
        if (athLineId) { chart.removeEntity(athLineId); athLineId = null; }
        else athLineId = chart.createShape({ price: coingecko.ath }, {
          shape:"horizontal_line",
          text: "ATH $" + coingecko.ath.toLocaleString()
        });
      });
    });

    function toggleMA(which, on) {
      if (!chart) return;
      if (which==='200d') {
        if (on && !sma200dId) sma200dId = chart.createStudy('Moving Average', false, false, [200]);
        if (!on && sma200dId) { chart.removeEntity(sma200dId); sma200dId=null; }
      } else {
        // approximate 200-week MA on daily chart
        if (on && !sma200wId) sma200wId = chart.createStudy('Moving Average', false, false, [1400]);
        if (!on && sma200wId) { chart.removeEntity(sma200wId); sma200wId=null; }
      }
    }

    /****************
     * CoinGecko IO *
     ****************/
    const coingecko = { ath:null, current:null, ma200d:null, ma200w:null };
    const CG = {
      marketChart(days){ return fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${days}&interval=daily`).then(r=>r.json()); },
      current(){ return fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd').then(r=>r.json()).then(j=>j.bitcoin.usd); },
      ath(){ return fetch('https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&community_data=false&developer_data=false&sparkline=false').then(r=>r.json()).then(j=>j?.market_data?.ath?.usd ?? null); }
    };

    function sma(arr, win){
      const out = new Array(arr.length).fill(null);
      let sum = 0;
      for(let i=0;i<arr.length;i++){
        sum += arr[i];
        if (i>=win) sum -= arr[i-win];
        if (i>=win-1) out[i] = sum/win;
      }
      return out;
    }

    async function fetchAndCompute(){
      try {
        const [mc, now, ath] = await Promise.all([
          CG.marketChart(1825), // 5y daily
          CG.current(),
          CG.ath()
        ]);
        const series = (mc?.prices||[]).map(([t,p])=>({t, p}));
        const values = series.map(x=>x.p);
        const ma200d = sma(values, 200);
        const ma1400d = sma(values, 1400);
        coingecko.ma200d = ma200d.at(-1);
        coingecko.ma200w = ma1400d.at(-1);
        coingecko.current = now;
        coingecko.ath = ath;
        document.getElementById('notifState').textContent =
          `Notifications: ${Notification.permission === 'granted' ? 'enabled' : 'pending'} ‚Ä¢ ` +
          `Spot ~$${now.toLocaleString()} ‚Ä¢ ` +
          (coingecko.ma200d ? `MA200 ~$${Math.round(coingecko.ma200d).toLocaleString()} ‚Ä¢ ` : '') +
          (coingecko.ma200w ? `MA200w ~$${Math.round(coingecko.ma200w).toLocaleString()}` : '');
      } catch(e){
        console.warn('CoinGecko fetch failed', e);
      }
    }

    /*********************
     * Browser Alerts IO *
     *********************/
    function near(a,b,eps=0.001){ if(!a||!b) return false; return Math.abs(a-b)/b < eps; }
    const lastAlert = { d:null, w:null, a:null };

    async function ensureNotif(){
      if (!('Notification' in window)) {
        document.getElementById('notifState').textContent = 'Notifications: not supported in this browser.';
        return;
      }
      if (Notification.permission !== 'granted'){
        const res = await Notification.requestPermission();
        if (res !== 'granted'){
          document.getElementById('notifState').textContent = 'Notifications: denied.';
          return;
        }
      }
      document.getElementById('notifState').textContent = 'Notifications: enabled';
    }

    async function alertLoop(){
      await fetchAndCompute();
      const c = coingecko.current, d = coingecko.ma200d, w = coingecko.ma200w, a = coingecko.ath;
      if (c && d && !lastAlert.d && near(c,d)) { new Notification('BTC near 200‚Äëday MA', { body:`~$${c.toLocaleString()}` }); lastAlert.d = Date.now(); }
      if (c && w && !lastAlert.w && near(c,w)) { new Notification('BTC near ~200‚Äëweek MA', { body:`~$${c.toLocaleString()}` }); lastAlert.w = Date.now(); }
      if (c && a && !lastAlert.a && c >= a) { new Notification('BTC at/above ATH üéâ', { body:`~$${c.toLocaleString()}` }); lastAlert.a = Date.now(); }
    }

    (async ()=>{ await ensureNotif(); await alertLoop(); setInterval(alertLoop, 60_000); })();

    /********************
     * mempool.space IO *
     ********************/
    const MP = {
      base: 'https://mempool.space/api',
      addrInfo(a){ return fetch(`${this.base}/address/${a}`).then(r=>{ if(!r.ok) throw new Error('Invalid address'); return r.json(); }); },
      addrUtxo(a){ return fetch(`${this.base}/address/${a}/utxo`).then(r=>r.json()); },
      addrTxs(a){ return fetch(`${this.base}/address/${a}/txs`).then(r=>r.json()); }
    };

    function satsToBTC(s){ return (s/1e8); }

    document.getElementById('addrBtn').addEventListener('click', async ()=>{
      const a = document.getElementById('addrInput').value.trim();
      const out = document.getElementById('addrResult');
      if (!a){ out.innerHTML = '<small>Please paste a Bitcoin address.</small>'; return; }
      out.textContent = 'Fetching‚Ä¶';
      try{
        const [info, utxos, txs] = await Promise.all([ MP.addrInfo(a), MP.addrUtxo(a), MP.addrTxs(a) ]);
        const bal = satsToBTC(info.chain_stats.funded_txo_sum - info.chain_stats.spent_txo_sum);
        out.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div><small>Address</small><div class="mono" style="word-break:break-all">${a}</div></div>
            <div><small>Balance</small><div class="mono">${bal.toFixed(8)} BTC</div></div>
          </div>
          <hr/>
          <small>UTXOs (first 10)</small>
          <ul style="margin:6px 0 12px 16px">
            ${(utxos||[]).slice(0,10).map(u=>`<li class="mono">${u.txid.slice(0,20)}‚Ä¶:${u.vout} ‚Äî ${(u.value/1e8).toFixed(8)} BTC ‚Äî ${u.status.confirmed?'confirmed':'pending'}</li>`).join('') || '<li class="mono">None</li>'}
          </ul>
          <small>Recent TXs (first 10)</small>
          <ul style="margin:6px 0 0 16px">
            ${(txs||[]).slice(0,10).map(t=>`<li class="mono">${t.txid.slice(0,24)}‚Ä¶ ‚Äî ${t.status.confirmed?'confirmed':'pending'}</li>`).join('') || '<li class="mono">None</li>'}
          </ul>
        `;
      }catch(e){
        out.innerHTML = `<small style="color:#e03a3a">Lookup failed: ${e.message}</small>`;
      }
    });

    document.getElementById('clearAddrBtn').addEventListener('click', ()=>{
      document.getElementById('addrInput').value='';
      document.getElementById('addrResult').innerHTML='<small>Enter a Bitcoin address to view balance, UTXOs and recent TXs.</small>';
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BitWatcher</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--line:#1f2a38;--muted:#9fb0c3;--text:#e7eef6;--accent:#f7931a}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    .pill{background:var(--card);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    main{max-width:1280px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:1000px){main{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar{justify-content:space-between;margin-bottom:10px}
    .btn{background:#0e141c;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input{background:#0e141c;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    label{color:var(--muted);font-size:13px}
    small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    hr{border:0;border-top:1px solid var(--line);margin:16px 0}
    /* chart panes */
    .pane{height:560px; display:none;}
    .pane.active{display:block;}
  </style>
</head>
<body>
<header>
  <h1>BitWatcher</h1>
  <span class="pill">Open‚Äësource ‚Ä¢ No tracking ‚Ä¢ Live chart</span>
</header>

<main>
  <!-- LEFT: Charts -->
  <section class="card">
    <div class="row toolbar">
      <div class="row">
        <label>Range</label>
        <button class="btn" data-view="day">1 Day</button>
        <button class="btn" data-view="1y">1 Year</button>
        <button class="btn" data-view="5y">5 Years</button>
      </div>
      <div class="row">
        <label><input type="checkbox" id="show200d" checked> 200‚Äëday MA</label>
        <label><input type="checkbox" id="show200w" checked> ~200‚Äëweek MA</label>
        <label><input type="checkbox" id="showATH" checked> ATH</label>
      </div>
    </div>

    <!-- three dedicated panes -->
    <div id="pane-day" class="pane active"></div>
    <div id="pane-1y"  class="pane"></div>
    <div id="pane-5y"  class="pane"></div>

    <small>
      Data: CoinGecko (prices & ATH). Charts: TradingView Lightweight Charts.
      200‚Äëweek MA shown as a horizontal level equal to the latest 1400‚Äëday SMA computed from 5y daily data.
    </small>
  </section>

  <!-- RIGHT: Sidebar (kept minimal for now) -->
  <aside class="card">
    <h3 style="margin:4px 0 8px">Donate BTC</h3>
    <p class="mono">3Q8gDB9QEgLP71ts3XDK7Ss45wMGjL6BHu</p>
    <small>Thank you for supporting development üôè</small>
    <hr />
    <small>Next: wallet lookup & alerts can be re‚Äëadded after charts feel perfect.</small>
  </aside>
</main>

<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script>
/** =========================
 *  Data sources (CoinGecko)
 *  ========================= */
const CG = {
  // prices: list of [timestamp_ms, price]
  marketChart(days, interval){ 
    const iv = interval ? `&interval=${interval}` : '';
    return fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${days}${iv}`)
      .then(r=>r.json());
  },
  // gets overall ATH (all-time, not just 5y)
  ath(){ 
    return fetch('https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&community_data=false&developer_data=false&sparkline=false')
      .then(r=>r.json())
      .then(j=>j?.market_data?.ath?.usd ?? null);
  }
};

function sma(values, window){
  const out = new Array(values.length).fill(null);
  let sum = 0;
  for (let i=0;i<values.length;i++){
    sum += values[i];
    if (i>=window) sum -= values[i-window];
    if (i>=window-1) out[i] = sum/window;
  }
  return out;
}

/** =========================
 *  Chart helpers
 *  ========================= */
function createBaseChart(container){
  const chart = LightweightCharts.createChart(container, {
    layout: { background: { color: '#121821' }, textColor: '#e7eef6' },
    grid: { vertLines: { color:'#1f2a38' }, horzLines: { color:'#1f2a38' } },
    rightPriceScale: { borderColor: '#1f2a38' },
    timeScale: { borderColor: '#1f2a38' },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });
  const series = chart.addAreaSeries({
    lineWidth: 2,
    priceLineVisible: false,
    topColor: 'rgba(247,147,26,0.25)',
    bottomColor: 'rgba(247,147,26,0.04)',
  });
  return { chart, series };
}

function toAreaData(prices){
  // CoinGecko returns [ms, price]; area series expects { time: seconds, value }
  return prices.map(([t,p]) => ({ time: Math.floor(t/1000), value: Number(p) }));
}

function last(arr){ return arr[arr.length-1]; }

/** Maintain three charts */
const panes = {
  day:  { el: document.getElementById('pane-day'),  chart:null, series:null, pricelines:[] },
  '1y': { el: document.getElementById('pane-1y'),   chart:null, series:null, pricelines:[] },
  '5y': { el: document.getElementById('pane-5y'),   chart:null, series:null, pricelines:[] },
};

let levels = { ma200d:null, ma200w:null, ath:null }; // computed once from 5y

function clearPriceLines(pane){
  pane.pricelines.forEach(pl => pane.series.removePriceLine(pl));
  pane.pricelines = [];
}
function addLevelLines(pane){
  clearPriceLines(pane);
  if (document.getElementById('show200d').checked && levels.ma200d){
    pane.pricelines.push(pane.series.createPriceLine({
      price: levels.ma200d, color: '#9fb0c3', lineWidth: 1, lineStyle: 2, title: 'MA 200D'
    }));
  }
  if (document.getElementById('show200w').checked && levels.ma200w){
    pane.pricelines.push(pane.series.createPriceLine({
      price: levels.ma200w, color: '#9fb0c3', lineWidth: 1, lineStyle: 2, title: '‚âà MA 200W'
    }));
  }
  if (document.getElementById('showATH').checked && levels.ath){
    pane.pricelines.push(pane.series.createPriceLine({
      price: levels.ath, color: '#f7931a', lineWidth: 1, lineStyle: 0, title: 'ATH'
    }));
  }
}

async function initLevels(){
  // Use 5y daily to compute MA200D & MA1400D; ATH from coin detail
  const [mc5y, ath] = await Promise.all([
    CG.marketChart(1825, 'daily'),
    CG.ath()
  ]);
  const prices5y = mc5y?.prices || [];
  const vals = prices5y.map(([t,p])=>Number(p));
  const ma200 = sma(vals, 200);
  const ma1400 = sma(vals, 1400);
  levels.ma200d = last(ma200);
  levels.ma200w = last(ma1400);
  levels.ath = ath || Math.max(...vals); // fallback if ATH endpoint limited
}

/** Load data & create per-pane charts */
async function buildDay(){
  if (!panes.day.chart){
    const { chart, series } = createBaseChart(panes.day.el);
    panes.day.chart = chart; panes.day.series = series;
  }
  const mc = await CG.marketChart(1, 'hourly'); // last 24h hourly points
  panes.day.series.setData(toAreaData(mc.prices||[]));
  addLevelLines(panes.day);
  panes.day.chart.timeScale().fitContent();
}

async function build1Y(){
  if (!panes['1y'].chart){
    const { chart, series } = createBaseChart(panes['1y'].el);
    panes['1y'].chart = chart; panes['1y'].series = series;
  }
  const mc = await CG.marketChart(365, 'daily');
  panes['1y'].series.setData(toAreaData(mc.prices||[]));
  addLevelLines(panes['1y']);
  panes['1y'].chart.timeScale().fitContent();
}

async function build5Y(){
  if (!panes['5y'].chart){
    const { chart, series } = createBaseChart(panes['5y'].el);
    panes['5y'].chart = chart; panes['5y'].series = series;
  }
  const mc = await CG.marketChart(1825, 'daily');
  panes['5y'].series.setData(toAreaData(mc.prices||[]));
  addLevelLines(panes['5y']);
  panes['5y'].chart.timeScale().fitContent();
}

/** View switching */
function setActive(view){
  Object.entries(panes).forEach(([k,p])=>{
    p.el.classList.toggle('active', k===view);
  });
}

document.querySelectorAll('button[data-view]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const v = btn.getAttribute('data-view');
    setActive(v);
    // fetch/render that pane on demand, then keep it cached
    if (v==='day')  await buildDay();
    if (v==='1y')   await build1Y();
    if (v==='5y')   await build5Y();
  });
});

/** Overlay toggles update lines on whichever pane is visible (and cached) */
['show200d','show200w','showATH'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=>{
    Object.values(panes).forEach(p => { if (p.chart) addLevelLines(p); });
  });
});

/** Boot */
(async function boot(){
  await initLevels();          // compute global levels once
  await buildDay();            // default: show day
  setActive('day');
})();
</script>
</body>
</html>
